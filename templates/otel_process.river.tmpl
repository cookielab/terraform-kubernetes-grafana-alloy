declare "otel_process" {
  argument "metrics_output" {
    optional = false
    comment  = "Where to send Prometheus metrics"
  }

  argument "otel_output" {
    optional = false
    comment  = "Where to send OTel metrics and traces"
  }

  argument "scrape_interval" {
    optional = true
    default  = "1m"
    comment  = "How often to scrape"
  }

  argument "scrape_timeout" {
    optional = true
    default  = "30s"
    comment  = "How long to wait before timing out"
  }

  otelcol.receiver.otlp "process" {
    http {
      endpoint = "0.0.0.0:${otel_http_port}"
    }
    grpc {
      endpoint = "0.0.0.0:${otel_grpc_port}"
    }

    output {
      traces  = [otelcol.processor.attributes.process.input]
      metrics = [otelcol.processor.attributes.process.input]
    }
  }

  otelcol.processor.attributes "process" {
    action {
      action = "upsert"
      key    = "k8s.cluster.name"
      value  = env("GRAFANA_AGENT_K8S_CLUSTER")
    }

    output {
      traces  = [otelcol.processor.k8sattributes.process.input]
      metrics = [otelcol.processor.k8sattributes.process.input]
    }
  }

  otelcol.processor.k8sattributes "process" {
    pod_association {
      source {
        from = "resource_attribute"
        name = "k8s.pod.ip"
      }
    }

    extract {
      label {
        from      = "pod"
        key_regex = "app.kubernetes.io/(.*)"
        tag_name  = "k8s.app.$1"
      }

      annotation {
        from      = "pod"
        key_regex = "app.gitlab.com/(.*)"
        tag_name  = "k8s.gl.$1"
      }

      metadata = [
        "k8s.namespace.name",
        "k8s.node.name",
        "k8s.pod.name",
        "k8s.pod.start_time",
        "k8s.pod.uid",
      ]
    }

    output {
      traces = [
        otelcol.connector.servicegraph.process.input,
        otelcol.connector.spanmetrics.process.input,
        otelcol.processor.batch.process.input,
      ]
      metrics = [otelcol.processor.batch.process.input]
    }
  }

  otelcol.connector.servicegraph "process" {
    dimensions = [
    %{ for dim in otel_service_graphs_dimensions ~}
    "${dim}",
    %{ endfor ~}
  ]


    output {
      metrics = [otelcol.processor.batch.process.input]
    }
  }

  otelcol.connector.spanmetrics "process" {
    histogram {
      exponential {}
    }

    output {
      metrics = [otelcol.processor.batch.process.input]
    }
  }

  otelcol.processor.batch "process" {
    output {
      traces  = [argument.otel_output.value]
      metrics = [otelcol.exporter.prometheus.process.input]
    }
  }

  otelcol.exporter.prometheus "process" {
    forward_to = [argument.metrics_output.value]
  }
}

// " vim: set ft=hcl
